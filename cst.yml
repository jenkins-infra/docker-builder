---
schemaVersion: 2.0.0

metadataTest:
  env:
    - key: "USER"
      value: "user"
    - key: "HOME"
      value: "/home/user"
    - key: "XDG_RUNTIME_DIR"
      value: "/run/user/1000"
  labels:
    - key: io.jenkins-infra.tools
      value: "img,container-structure-test,git,make,hadolint"
    - key: io.jenkins-infra.tools.hadolint.version
      value: "1.19.0"
    - key: io.jenkins-infra.tools.container-structure-test.version
      value: "1.10.0"
    - key: io.jenkins-infra.tools.img.version
      value: "0.5.11"
  entrypoint: []
  cmd: ["/bin/bash"]
  workdir: "/app"

fileExistenceTests:
  - name: 'Google Container Test CLI'
    path: '/usr/local/bin/container-structure-test'
    shouldExist: true
    isExecutableBy: 'any'
  - name: 'HADOLINT'
    path: '/usr/local/bin/hadolint'
    shouldExist: true
    isExecutableBy: 'any'
  - name: 'img'
    path: '/usr/bin/img'
    shouldExist: true
    isExecutableBy: 'any'
  - name: 'img newuidmap'
    path: '/usr/bin/newuidmap'
    shouldExist: true
    isExecutableBy: 'any'
  - name: 'img newgidmap'
    path: '/usr/bin/newgidmap'
    shouldExist: true
    isExecutableBy: 'any'
  - name: 'Bash'
    path: '/bin/bash'
    shouldExist: true
    isExecutableBy: 'any'
  - name: 'Curl'
    path: '/usr/bin/curl'
    shouldExist: true
    isExecutableBy: 'any'
  - name: 'Make'
    path: '/usr/bin/make'
    shouldExist: true
    isExecutableBy: 'any'
  - name: 'Git'
    path: '/usr/bin/git'
    shouldExist: true
    isExecutableBy: 'any'
  - name: 'Git'
    path: '/usr/bin/pigz'
    shouldExist: true
    isExecutableBy: 'any'
  - name: 'subuid'
    path: '/etc/subuid'
    shouldExist: true
  - name: 'subgid'
    path: '/etc/subgid'
    shouldExist: true
  - name: 'user directory'
    path: '/run/user/1000'
    shouldExist: true
  - name: 'home user'
    path: '/home/user'
    shouldExist: true

fileContentTests:
  - name: 'image user created as non-root user'
    path: '/etc/passwd'
    expectedContents: ['.*user:x:1000:1000.*']
  - name: 'subuid contains user with 65,536 subordinate UIDs'
    path: '/etc/subuid'
    expectedContents: ['.*user:100000:65536.*']
  - name: 'subgid contains user 65,536 subordinate GIDs'
    path: '/etc/subgid'
    expectedContents: ['.*user:100000:65536.*']
